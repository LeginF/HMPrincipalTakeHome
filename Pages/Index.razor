@page "/"
@inject HttpClient Http




<table>
    <tr>
        <th>GitHub Authorizaton Token</th>
        <th><input @bind="AuthorizationToken" width="200"/></th>
        <th>@AuthorizationError</th>
    </tr>
    <tr>
        <th>Topic</th>
        <th><input @bind="Topic" /></th>
        <th>@TopicError</th>
    </tr>
</table>
&nbsp;<br />
<button class="btn btn-primary" @onclick="Search">Search</button>
&nbsp;<br />


@if (_responses != null)
{
    @if (_responses.total_count < 1)
    {
        <span>No search results</span>
    }
    else
    {
    <table class='table'>
        <thead>
            <tr>
                <th>Name</th>
                <th>Description &amp; Topics</th>
                <th>Contributors</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in _responses.items)
            {
                <tr>
                    <td>@item.name</td>
                    <td>
                        <b>Description:</b>&nbsp;@item.description<br />
                        @if (item.owner != null)
                        {
                            <b>Topics:</b><span>&nbsp;</span><TopicsControl Owner="@item.owner.login" Repo="@item.name" AuthToken="@AuthorizationToken" />
                        }
                    </td>
                    <td>
                        <b>Contributors:</b>&nbsp;
                        <Contributors contributors_url="@item.contributors_url" authToken="@AuthorizationToken"/>
                    </td>
                </tr>
            }

        </tbody>
    </table>
    }
    }


@code 
{
    private string Topic {get; set; }
    private string AuthorizationToken { get; set; }
    private string TopicError { get; set; }
    private string AuthorizationError { get; set; }

    public class Repository
    {
        public string id {get;set;}
        public string node_id {get;set;}
        public string name {get;set;}
        public string full_name{get;set;}
        public Owner owner { get; set; }
    }

    public class Owner
    {
        public string login { get; set; }
    }


    private class Item
    {
        public string name {get;set;}
        public string path {get;set;}
        public string sha {get;set;}
        public string url {get;set;}
        public string git_url {get;set;}
        public string html_url {get;set;}
        public string description{get;set;}
        public string collaborators_url{get; set;}
        public Repository repository { get;set;}
        public string collaborators { get; set; }
        public string contributors_url { get; set; }
        public string contributors { get; set; }
        public string tags_url { get; set; }
        public string topics { get; set; }
        public Owner owner { get; set; }
    }


    private class Response
    {
        public int total_count {get;set;}
        public bool incomplete_results {get;set;}
        public List<Item> items{get;set;}
    }

    private Response _responses = null; //new Response();


}

@functions 
{


    async Task Search()
    {
        try
        {
            if (NoErrors())
            {
                try
                {
                    using(var client = new HttpClient())
                    {
                        _responses = null;
                        StateHasChanged();
                        client.DefaultRequestHeaders.Accept.Add(new System.Net.Http.Headers.MediaTypeWithQualityHeaderValue("application/vnd.github.v3+json"));
                        var url = "https://api.github.com/search/repositories?q=topic:" + Topic;
                        _responses = await client.GetJsonAsync<Response>(url);
                        StateHasChanged();
                    }
                }
                catch (Exception ex)
                {
                    AuthorizationError = ex.Message;
                    StateHasChanged();
                }
            }

        }
        catch(Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
        StateHasChanged();
    }

    private bool NoErrors()
    {
        var retVal = true;
        AuthorizationError = TopicError = string.Empty;

        if (string.IsNullOrWhiteSpace(AuthorizationToken))
        {
            AuthorizationError = "Please provide an authorization token.";
            retVal = false;
        }

        if (string.IsNullOrWhiteSpace(Topic))
        {
            TopicError = "Please provide a topic to search for";
            retVal = false;
        }

        return retVal;
    }

    
}